<?php
/*
Plugin Name: Uploads Malware Remover
Description: Removes .php files from /wp-content/uploads/ directory and subfolders and shows sample files.
Version: 1.0
Author: Yatosha Web Services
Author URI: https://yatosha.com
*/


// Function to remove .php files recursively
function remove_malware_files_recursive($directory) {
    $files = glob($directory . '/*.php');
    foreach ($files as $file) {
        unlink($file);
    }

    $subfolders = glob($directory . '/*', GLOB_ONLYDIR);
    foreach ($subfolders as $subfolder) {
        remove_malware_files_recursive($subfolder);
    }
}

// Function to list up to 20 sample .php files
function list_sample_php_files() {
    $uploads_dir = wp_upload_dir(); // Get the uploads directory
    $uploads_path = $uploads_dir['basedir']; // Full path to /wp-content/uploads/

    // Get up to 20 .php files recursively
    $sample_files = array();
    $iterator = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($uploads_path),
        RecursiveIteratorIterator::SELF_FIRST
    );
    
    foreach ($iterator as $file) {
        if ($file->isFile() && $file->getExtension() === 'php') {
            $sample_files[] = $file->getPathname();
        }
    }
    
    $sample_files = array_slice($sample_files, 0, 20);

    if (!empty($sample_files)) {
        echo '<h2>Sample .php Files:</h2>';
        echo '<ul>';
        foreach ($sample_files as $file) {
            echo '<li>' . esc_html(str_replace($uploads_path, '', $file)) . '</li>';
        }
        echo '</ul>';
    } else {
        echo '<p>No .php files found in /wp-content/uploads/ or its subfolders.</p>';
    }
}

// Hook the admin menu page function
add_action('admin_menu', 'add_malware_remover_page');

// Function to add an admin menu page with the menu item text as "Uploads Malware Remover"
function add_malware_remover_page() {
    add_menu_page(
        'Uploads Malware Remover',
        'Uploads Malware Remover',
        'manage_options',
        'uploads-malware-remover', // Updated menu slug
        'run_malware_remover',
        'dashicons-shield',
        20
    );
}

// Function to run the malware remover and list sample files when the buttons are clicked
function run_malware_remover() {
    if (isset($_POST['delete_malware']) && current_user_can('manage_options')) {
        $uploads_dir = wp_upload_dir(); // Get the uploads directory
        $uploads_path = $uploads_dir['basedir']; // Full path to /wp-content/uploads/
        remove_malware_files_recursive($uploads_path);
        echo '<div class="updated"><p>Malware files removed successfully!</p></div>';
    }

    // Display informative text
    echo '<div class="wrap">';
    echo '<h1>Malware Remover</h1>';
    echo '<p>Use this tool to remove malicious .php files from /wp-content/uploads/ directory and its subfolders.</p>';

    // Display the "Delete Malware" button
    echo '<h2>Delete Malware Files</h2>';
    echo '<form method="post">';
    echo '<p>Click the button below to delete malicious .php files:</p>';
    echo '<input type="submit" name="delete_malware" class="button button-primary" value="Delete Malware">';
    echo '</form>';

    if (isset($_POST['preview_malware']) && current_user_can('manage_options')) {
        list_sample_php_files();
    }

    // Display the "Preview Malware" button
    echo '<h2>Preview Malware Files</h2>';
    echo '<form method="post">';
    echo '<p>Click the button below to preview up to 20 sample .php files:</p>';
    echo '<input type="submit" name="preview_malware" class="button button-secondary" value="Preview Malware">';
    echo '</form>';
    
    echo '</div>'; // Close the wrap div
}
